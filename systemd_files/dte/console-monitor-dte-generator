#!/bin/bash
# console-monitor-dte-generator
# 
# 这是一个 systemd generator 脚本
# 放置位置: /lib/systemd/system-generators/console-monitor-dte-generator
# 
# Generator 在启动时被调用，参数为:
#   $1 = normal-dir   (通常是 /run/systemd/generator)
#   $2 = early-dir    (通常是 /run/systemd/generator.early)  
#   $3 = late-dir     (通常是 /run/systemd/generator.late)

set -e

NORMAL_DIR="$1"
EARLY_DIR="$2"
LATE_DIR="$3"

# 创建配置目录
mkdir -p /run/console-monitor-dte

# 读取 kernel 命令行参数
CMDLINE=$(cat /proc/cmdline)

# 解析所有 console= 参数
# 格式: console=ttyS0,9600 或 console=ttyS0,9600n8
parse_console_args() {
    local cmdline="$1"
    
    # 使用正则表达式匹配 console=ttyXXX,BAUDRATE 格式
    # 支持: console=ttyS0,9600 console=ttyS1,115200n8 等
    for arg in $cmdline; do
        if [[ "$arg" =~ ^console=([^,]+)(,([0-9]+))?(.*)$ ]]; then
            local tty="${BASH_REMATCH[1]}"
            local baudrate="${BASH_REMATCH[3]:-9600}"  # 默认 9600
            
            # 跳过 tty0 (虚拟控制台)
            if [[ "$tty" == "tty0" ]]; then
                continue
            fi
            
            # 输出找到的串口配置
            echo "Found console: $tty with baudrate: $baudrate"
            
            # 生成服务实例的环境配置文件
            echo "BAUDRATE=$baudrate" > "/run/console-monitor-dte/${tty}.conf"
            echo "TTY_DEVICE=/dev/${tty}" >> "/run/console-monitor-dte/${tty}.conf"
            
            # 在 generator 目录中创建服务实例的符号链接
            # 这会让 systemd 自动启动对应的服务实例
            mkdir -p "${NORMAL_DIR}/multi-user.target.wants"
            ln -sf "/lib/systemd/system/console-monitor-dte@.service" \
                   "${NORMAL_DIR}/multi-user.target.wants/console-monitor-dte@${tty}.service"
        fi
    done
}

parse_console_args "$CMDLINE"

exit 0
